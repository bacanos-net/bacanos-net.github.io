<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bacanos Store — Filtro e Detalhes</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="jolly_roger_sapofrog.png" type="image/x-icon">
    <link href='https://fonts.googleapis.com/css?family=JetBrains Mono' rel='stylesheet'>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
</head>
<body>
    <header>
        <div class="logo">
            <h1>BacanosStore</h1><img src="jolly_roger_sapofrog.png">
        </div>

        <div class="search-bar">
            <input type="text" id="header-busca" placeholder="Buscar jogos...">
            <div id="suggestions" class="suggestions"></div>
            <button id="header-buscar">Buscar</button>
        </div>
    </header>
    <nav>
            <ul>
                <li><a href="bacanosstore.html">Início</a></li>
                <li><a href="allgames.html">Jogos</a></li>
                <li><a href="promocao.html">Promoções</a></li>
                <li><a href="novidade.html">Novidades</a></li>
                <li><a href="contato.html">Contato</a></li>
            </ul>
        </nav>
  <h1>Bacanos Store</h1>

  <label for="filter">Filtrar por gênero:</label>
  <select id="filter">
    <option value="todos">Todos</option>
  </select>

  <input type="text" id="busca" placeholder="Buscar jogo..." />
  <button id="anterior">←</button>
  <span id="pagina-atual">1</span>
  <button id="proximo">→</button>
  <div id="lista-jogos"></div>

  <div id="detalhes" style="display:none;">
    <button id="voltar">← Voltar</button>
    <img id="detalhe-img" alt="" />
    <h2 id="detalhe-titulo"></h2>
    <p id="detalhe-descricao"></p>
    <p><strong>Gêneros:</strong> <span id="detalhe-generos"></span></p>
    <p><strong>Data de lançamento:</strong> <span id="detalhe-release"></span></p>
    <p><strong>Preço:</strong> <span id="detalhe-preco"></span></p>
    <!-- O container de downloads será criado via JS -->
  </div>

<script>
const listaJogos = document.getElementById('lista-jogos');
const filterSelect = document.getElementById('filter');
const buscaInput = document.getElementById('busca');
const detalhesDiv = document.getElementById('detalhes');
const voltarBtn = document.getElementById('voltar');

let paginaAtual = 1;
let jogos = [];
let todosJogos = [];
let generosSet = new Set();
const JOGOS_POR_PAGINA = 20;

function criarCard(jogo) {
  const card = document.createElement('div');
  card.className = 'card';
  card.innerHTML = `
    <img src="https://cdn.cloudflare.steamstatic.com/steam/apps/${jogo.appid}/header.jpg" alt="${jogo.name}" />
    <div class="info">
      <div class="title">${jogo.name}</div>
      <button class="comprar-btn">Download</button>
    </div>
  `;
  // Apenas o botão abre os detalhes
  card.querySelector('.comprar-btn').onclick = (e) => {
    e.stopPropagation();
    mostrarDetalhes(jogo);
  };
  return card;
}

async function mostrarDetalhes(jogo) {
  detalhesDiv.style.display = 'block';
  listaJogos.style.display = 'none';
  document.getElementById('detalhe-titulo').textContent = jogo.name;
  document.getElementById('detalhe-generos').textContent = (jogo.genres || []).join(', ');
  document.getElementById('detalhe-release').textContent = jogo.release_date || 'Desconhecida';
  document.getElementById('detalhe-preco').textContent = jogo.price || 'Indisponível';
  document.getElementById('detalhe-img').src = jogo.header_image || `https://cdn.cloudflare.steamstatic.com/steam/apps/${jogo.appid}/header.jpg`;
  document.getElementById('detalhe-descricao').textContent = jogo.short_description || 'Sem descrição disponível';

  // Remove container antigo se existir
  let linksContainer = document.getElementById('detalhe-downloads');
  if (linksContainer) linksContainer.remove();

  linksContainer = document.createElement('div');
  linksContainer.id = 'detalhe-downloads';
  linksContainer.innerHTML = '<p><strong>Downloads:</strong></p>';

  // Fontes de download
  const fontes = [
    { nome: 'Online Fix', arquivo: 'onlinefix.json' },
    { nome: 'DODI', arquivo: 'dodi.json' },
    { nome: 'AtopGames', arquivo: 'atop-games.json' },
    { nome: 'SteamRip', arquivo: 'steamrip.json' },
    { nome: 'GOG', arquivo: 'gog.json' }
  ];

  // Função para buscar e mostrar links de cada fonte
  for (const fonte of fontes) {
    const fonteDiv = document.createElement('div');
    fonteDiv.innerHTML = `<strong>${fonte.nome}:</strong> <span>Carregando...</span>`;
    linksContainer.appendChild(fonteDiv);

    try {
      const res = await fetch(fonte.arquivo);
      let data;
      try {
        data = await res.json();
      } catch {
        data = null;
      }

            let resultados = [];
      if (data && Array.isArray(data)) {
        // Busca fuzzy usando Fuse.js
        const fuse = new Fuse(data, {
          keys: ['title'],
          threshold: 0.4 // Ajuste se necessário
        });
        const resultadosFuse = fuse.search(jogo.name);
        resultados = resultadosFuse.map(r => r.item);
      } else if (data && typeof data === 'object') {
        // Caso o JSON seja objeto (ex: onlinefix)
        if (Array.isArray(data.downloads)) {
          const fuse = new Fuse(data.downloads, {
            keys: ['title'],
            threshold: 0.2
          });
          const resultadosFuse = fuse.search(jogo.name);
          resultados = resultadosFuse.map(r => r.item);
        }
      }

      if (resultados.length > 0) {
        const ul = document.createElement('ul');
        resultados.forEach(item => {
          const li = document.createElement('li');
          if (item.uris && item.uris[0]) {
            li.innerHTML = `<a href="${item.uris[0]}" target="_blank">${item.title || 'Download'}</a> (${item.fileSize || ''})`;
          } else {
            li.textContent = item.title || 'Download';
          }
          ul.appendChild(li);
        });
        fonteDiv.querySelector('span').replaceWith(ul);
      } else {
        fonteDiv.querySelector('span').textContent = 'sem resultados para essa fonte';
      }
    } catch {
      fonteDiv.querySelector('span').textContent = 'sem resultados para essa fonte';
    }
  }

  detalhesDiv.appendChild(linksContainer);
}

function popularFiltro() {
  filterSelect.innerHTML = '<option value="todos">Todos</option>';
  Array.from(generosSet).sort().forEach(g => {
    const opt = document.createElement('option');
    opt.value = g;
    opt.textContent = g;
    filterSelect.appendChild(opt);
  });
}

function filtrarJogos() {
  const filtro = filterSelect.value;
  const busca = buscaInput.value.trim().toLowerCase();
  let filtrados = todosJogos;

  // Filtro por gênero (se houver campo genres)
  if (filtro !== 'todos') {
    filtrados = filtrados.filter(j => (j.genres || []).includes(filtro));
  }

  // Busca por nome
  if (busca) {
    filtrados = filtrados.filter(j => j.name && j.name.toLowerCase().includes(busca));
  }

  // Atualiza generosSet para o filtro
  generosSet.clear();
  filtrados.forEach(j => {
    if (j.genres) j.genres.forEach(g => generosSet.add(g));
  });

  popularFiltro();

  // Paginação
  const inicio = (paginaAtual - 1) * JOGOS_POR_PAGINA;
  const fim = inicio + JOGOS_POR_PAGINA;
  jogos = filtrados.slice(inicio, fim);

  listaJogos.innerHTML = '';
  jogos.forEach(jogo => {
    listaJogos.appendChild(criarCard(jogo));
  });

  document.getElementById('pagina-atual').textContent = paginaAtual;
}

async function carregarJogos() {
  listaJogos.textContent = 'Carregando...';
  await carregarTodosJogos();
  filtrarJogos();
}

// Substitua tudo relacionado a carregarJogosSteamSpy e mantenha só carregarTodosJogos:
async function carregarTodosJogos() {
  if (todosJogos.length > 0) return;
  const response = await fetch('steamspy.json');
  const text = await response.text();
  const lines = text.split('\n').filter(line => line.trim() !== '');
  const jogos = [];
  let jogo = {};
  for (const line of lines) {
    if (/^\d+$/.test(line.trim())) {
      if (Object.keys(jogo).length > 0) {
        jogos.push(jogo);
        jogo = {};
      }
      continue;
    }
    const [key, ...rest] = line.split('\t');
    if (key && rest.length > 0) {
      let value = rest.join('\t').replace(/^"|"$/g, '');
      if (!isNaN(value) && value.trim() !== '') value = Number(value);
      jogo[key.trim()] = value;
    }
  }
  if (Object.keys(jogo).length > 0) jogos.push(jogo);
  todosJogos = jogos.filter(j => j && j.name);
  // Atualiza generosSet para todos os jogos
  generosSet.clear();
  todosJogos.forEach(j => {
    if (j.genres) j.genres.forEach(g => generosSet.add(g));
  });
}

filterSelect.addEventListener('change', () => {
  paginaAtual = 1;
  filtrarJogos();
});

buscaInput.addEventListener('input', () => {
  paginaAtual = 1;
  filtrarJogos();
});

document.getElementById('proximo').onclick = () => {
  paginaAtual++;
  filtrarJogos();
};
document.getElementById('anterior').onclick = () => {
  if (paginaAtual > 1) {
    paginaAtual--;
    filtrarJogos();
  }
};

// Sincroniza a barra de pesquisa do header com a busca da lista
const headerBuscaInput = document.getElementById('header-busca');
const headerBuscarBtn = document.getElementById('header-buscar');

if (headerBuscaInput && buscaInput) {
  headerBuscaInput.addEventListener('input', () => {
    buscaInput.value = headerBuscaInput.value;
    paginaAtual = 1;
    filtrarJogos();
  });
  if (headerBuscarBtn) {
    headerBuscarBtn.addEventListener('click', () => {
      buscaInput.value = headerBuscaInput.value;
      paginaAtual = 1;
      filtrarJogos();
    });
  }
  buscaInput.addEventListener('input', () => {
    headerBuscaInput.value = buscaInput.value;
  });
}

voltarBtn.addEventListener('click', () => {
  detalhesDiv.style.display = 'none';
  listaJogos.style.display = '';
});

carregarJogos();

</script>

</body>
</html>
